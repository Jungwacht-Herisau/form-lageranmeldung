<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Anmeldung Sommerlager</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"
            integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4/dist/signature_pad.umd.min.js"></script>
</head>
<body>
<form id="registration_form" novalidate>
    <h2>Personalien</h2>
    <div class="mb-3 row">
        <div class="col">
            <label for="first_name" class="form-label">Vorname</label>
            <input type="text" class="form-control" id="first_name" name="first_name" required>
        </div>
        <div class="col">
            <label for="last_name" class="form-label">Nachname</label>
            <input type="text" class="form-control" id="last_name" name="last_name" required>
        </div>
    </div>
    <div class="mb-3 row">
        <div class="col">
            <label for="birth_date" class="form-label">Geburtsdatum</label>
            <input type="date" class="form-control" id="birth_date" name="birth_date" required>
        </div>
        <div class="col">
            <label for="gender" class="form-label">Geschlecht</label>
            <select class="form-select" id="gender" name="gender" required>
                <option value="M">Männlich</option>
                <option value="W">Weiblich</option>
            </select>
        </div>
    </div>
    <div class="mb-3 row">
        <div class="col">
            <label for="email" class="form-label">E-Mail Adresse</label>
            <input type="email" class="form-control" id="email" name="email" required>
        </div>
        <div class="col">
            <label for="ahv_number" class="form-label">AHV-Nummer</label>
            <input class="form-control" id="ahv_number" name="ahv_number" placeholder="756.XXXX.XXXX.XX" required
                   pattern="756\.\d{4}\.\d{4}\.\d{2}">
            <div class="invalid-feedback">Diese AHV-Nummer ist ungültig</div>
        </div>
    </div>

    <h2>Verpflegung</h2>
    <div class="mb-3">
        <input type="checkbox" class="form-check-input" id="vegetarian" name="vegetarian">
        <label for="vegetarian" class="form-check-label">Vegetarisch</label>
    </div>
    <div class="mb-3">
        <label for="food_intolerances" class="form-label">Essensunverträglichkeiten</label>
        <input class="form-control" id="food_intolerances" name="food_intolerances">
    </div>

    <h2>Gruppe</h2>
    <div class="mb-3">
        <input type="checkbox" class="form-check-input" id="in_jwbr" name="in_jwbr">
        <label for="in_jwbr" class="form-label">Ich bin in der Schar Jungwacht Blauring Herisau</label>
    </div>
    <div class="mb-3">
        <label for="group" class="form-label">Gruppe</label>
        <select class="form-select" id="group" name="group" required>
            <option value="Ivaros">JW - Ivaros</option>
            <option value="Chanticos">JW - Chanticos</option>
            <option value="Ueblos">JW - Ueblos</option>
            <option value="Cherokees">JW - Cherokees</option>
            <option value="Mukavajates">JW - Mukavajates</option>
            <option value="Theseus">JW - Theseus</option>
            <option value="Mevas">BR - Mevas</option>
            <option value="Picus">BR - Picus</option>
            <option value="Mahinas">BR - Mahinas</option>
            <option value="Giblias">BR - Giblias</option>
            <option value="Gorayadas">BR - Gorayadas</option>
            <option value="Lacasitas">BR - Lacasitas</option>
        </select>
    </div>

    <h2>Eltern</h2>
    <div class="mb-3">
        <label for="parents_name" class="form-label">Name der Eltern</label>
        <input type="text" class="form-control" id="parents_name" name="parents_name" required>
    </div>
    <div class="mb-3">
        <label for="parents_address" class="form-label">Anschrift</label>
        <textarea id="parents_address" name="parents_address" class="form-control" rows="5" required></textarea>
    </div>
    <div class="mb-3 row">
        <div class="col-md-4 col-sm-12">
            <label for="tel_private" class="form-label">Tel. Privat</label>
            <input type="tel" class="form-control" id="tel_private" name="tel_private" required>
        </div>
        <div class="col-md-4 col-sm-12">
            <label for="tel_mobile" class="form-label">Tel. Mobil</label>
            <input type="tel" class="form-control" id="tel_mobile" name="tel_mobile">
        </div>
        <div class="col-md-4 col-sm-12">
            <label for="tel_work" class="form-label">Tel. Geschäft</label>
            <input type="tel" class="form-control" id="tel_work" name="tel_work">
        </div>
    </div>

    <h2>Medizinische Informationen</h2>
    <p>Die Versicherung ist Sache der Teilnehmer!!</p>
    <div class="mb-3 row">
        <div class="col">
            <label for="accident_insurance" class="form-label">Unfallversicherung</label>
            <input type="text" class="form-control" id="accident_insurance" name="accident_insurance" required>
        </div>
        <div class="col">
            <label for="sickness_insurance" class="form-label">Krankenkasse</label>
            <input type="text" class="form-control" id="sickness_insurance" name="sickness_insurance" required>
        </div>
    </div>
    <div class="mb-3">
        <label for="doctor_contact" class="form-label">Name, Anschrift und Telefon Hausarzt</label>
        <textarea id="doctor_contact" name="doctor_contact" class="form-control" rows="5" required></textarea>
    </div>
    <div class="mb-3">
        <label for="allergies" class="form-label">Allergien</label>
        <input type="text" id="allergies" name="allergies" class="form-control">
    </div>
    <div class="mb-3">
        <input type="checkbox" class="form-check-input" id="tetanus_vaccinated" name="tetanus_vaccinated">
        <label for="tetanus_vaccinated" class="form-check-label">Gegen Starrkrampf geimpft</label>
    </div>
    <div class="mb-3">
        <input type="checkbox" class="form-check-input" id="tick_vaccinated" name="tick_vaccinated">
        <label for="tick_vaccinated" class="form-check-label">Gegen Zecken geimpft</label>
    </div>
    <div class="mb-3">
        <label class="form-label" for="diseases">Vorliegende Erkrankungen</label>
        <input type="text" class="form-control" id="diseases" name="diseases"
               placeholder="Asthma, ADHS, Herzfehler, etc.">
    </div>
    <div class="mb-3">
        <label class="form-label" for="regularly_taken_medications">
            Medikamente, die regelmässig eingenommen werden müssen
        </label>
        <input type="text" class="form-control" id="regularly_taken_medications" name="regularly_taken_medications">
    </div>
    <div class="mb-3 row">
        <div class="col">
            <label for="vaccination_card" class="form-label">Impfausweis</label>
            <input class="form-control" type="file" id="vaccination_card" name="vaccination_card">
        </div>
        <div class="col">
            <label for="insurance_card" class="form-label">Krankenkassenkarte</label>
            <input class="form-control" type="file" id="insurance_card" name="insurance_card">
        </div>
    </div>

    <h2>Anwesenheit</h2>
    <div class="mb-3">
        <input type="checkbox" class="form-check-input" id="present_week_1" name="present_week_1">
        <label for="present_week_1" class="form-check-label">Anwesend in der ersten Woche
            (08.07.2023-15.07.2023)</label>
    </div>
    <div class="mb-3">
        <input type="checkbox" class="form-check-input" id="present_week_2" name="present_week_2">
        <label for="present_week_2" class="form-check-label">Anwesend in der zweiten Woche
            (15.07.2023-22.07.2023)</label>
    </div>

    <h2>Allgemeines</h2>
    <div class="mb-3">
        <label for="remarks" class="form-label">Bemerkungen</label>
        <textarea id="remarks" name="remarks" class="form-control" rows="5"></textarea>
    </div>
    <div class="mb-3 d-flex">
        <input type="checkbox" class="form-check-input me-2" id="allow_photos" name="allow_photos" required>
        <label for="allow_photos" class="form-check-label">Ich bin damit einverstanden, dass im Lager gemachte Fotos
            von Jungwacht Blauring Herisau weiterverwendet werden dürfen, insbesondere für soziale
            Netzwerke, Zeitungen, Lagerblog und die Homepage.</label>
        <div class="invalid-feedback">Diese Checkbox muss aktiviert sein</div>
    </div>

    <h2>Unterschrift</h2>
    <div class="mb-3">
        <div class="wrapper">
            <canvas id="signature-pad" width="400" height="200"></canvas>
        </div>
        <div class="clear-btn">
            <button id="signature-clear" class="btn btn-sm btn-secondary" type="button">Neu beginnen</button>
        </div>
    </div>
    <button type="button" class="btn btn-primary" id="form_submit">Anmeldung abschicken</button>
</form>
<div id="success" style="display: none">
    <h2>Anmeldung abgeschickt</h2>
    <p>Vielen Dank für deine Anmeldung! Du wirst in Kürze eine Mail als Bestätigung erhalten.</p>
    <a href=".">Zurück zum Anmeldeformular</a>
</div>
<div id="form_send_error" style="display: none" class="alert alert-danger fade show">
    Leider konnte das Formular nicht abgeschickt werden. Bitte versuch es später noch einmal.
</div>
<script>
    async function readFileInputToFormObject(input_id) {
        const reader = new FileReader();
        const file = document.getElementById(input_id).files[0];
        const result = await new Promise((resolve, reject) => {
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });

        return result.toString();
    }

    document.addEventListener("DOMContentLoaded", () => {
        const canvas = document.getElementById("signature-pad");
        const signaturePad = new SignaturePad(canvas, {
            backgroundColor: 'rgb(250,250,250)'
        });

        /*function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear(); // otherwise isEmpty() might return incorrect value
        }

        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();
        */

        document.getElementById("signature-clear").addEventListener("click", () => signaturePad.clear());


        const form = document.getElementById("registration_form");
        let success_msg = document.getElementById("success");
        let error_msg = document.getElementById("form_send_error");

        document.getElementById("form_submit").addEventListener("click", async event => {
            form.classList.add('was-validated');
            if (!form.checkValidity()) {
                console.log("form invalid");
                event.preventDefault();
                event.stopPropagation();
            } else {
                const xhr = new XMLHttpRequest();
                const formData = new FormData(form);
                let functionURL = window.location.hostname === "localhost"
                    ? 'http://localhost:7071/api/Anmeldung'
                    : "https://lageranmeldung.azurewebsites.net/api/Anmeldung?code=X1SFOMDAP9DSTGlr8YM2A1eWg_-_HZ1IVs5tAhdheb7MAzFuRC9u5Q==";
                xhr.open('POST', functionURL);
                xhr.setRequestHeader("Content-Type", "application/json");

                let dataObject = Object.fromEntries(formData);
                dataObject.vaccination_card = await readFileInputToFormObject("vaccination_card");
                dataObject.insurance_card = await readFileInputToFormObject("insurance_card");
                dataObject.signature = signaturePad.toDataURL("image/png");

                xhr.send(JSON.stringify(dataObject));
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (200 <= xhr.status && xhr.status < 300) {
                            form.reset();
                            form.style.display = "none";
                            error_msg.style.display = "none";
                            success_msg.style.display = "initial";
                        } else {
                            error_msg.style.display = "initial";
                        }
                        console.log(xhr.status, xhr.statusText);
                        console.log(xhr.response);
                    }
                }
            }

            return false;
        });

        ["input", "textarea", "select"].forEach(tag => document.querySelectorAll(`${tag}:required`).forEach(add_invalid_feedback_if_needed));
    });

    function add_invalid_feedback_if_needed(inp) {
        if (inp.parentNode.querySelector(".invalid-feedback") == null) {
            let div = document.createElement("div");
            div.classList.add("invalid-feedback");
            div.innerText = "Dieses Feld darf nicht leer sein.";
            inp.parentNode.insertBefore(div, inp.nextSibling);
        }
    }
</script>
</body>
</html>