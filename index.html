<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Anmeldung Sommerlager</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abel">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"
            integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4/dist/signature_pad.umd.min.js"></script>

    <style>
        body {
            font-family: "Abel", serif;
            overflow-x: clip;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: "Lora", serif;
        }
    </style>
</head>
<body>
<form id="registration_form" novalidate>
    <h2>Personalien</h2>
    <div class="mb-3 row">
        <div class="col">
            <label for="first_name" class="form-label">Vorname</label>
            <input type="text" class="form-control" id="first_name" name="first_name" required>
        </div>
        <div class="col">
            <label for="last_name" class="form-label">Nachname</label>
            <input type="text" class="form-control" id="last_name" name="last_name" required>
        </div>
    </div>
    <div class="mb-3 row">
        <div class="col">
            <label for="birth_date" class="form-label">Geburtsdatum</label>
            <input type="date" min="1950-01-01" class="form-control" id="birth_date" name="birth_date" required>
        </div>
        <div class="col">
            <label for="gender" class="form-label">Geschlecht</label>
            <select class="form-select" id="gender" name="gender" required>
                <option value="M">Männlich</option>
                <option value="W">Weiblich</option>
            </select>
        </div>
    </div>
    <div class="mb-3 row">
        <div class="col">
            <label for="email" class="form-label">E-Mail Adresse</label>
            <input type="email" class="form-control" id="email" name="email" required>
        </div>
        <div class="col">
            <label for="ahv_number" class="form-label">AHV-Nummer</label>
            <input class="form-control" id="ahv_number" name="ahv_number" placeholder="756.XXXX.XXXX.XX" required
                   pattern="756\.\d{4}\.\d{4}\.\d{2}">
            <div class="invalid-feedback">Diese AHV-Nummer ist ungültig</div>
        </div>
    </div>

    <h2>Verpflegung</h2>
    <div class="mb-3">
        <input type="checkbox" class="form-check-input" id="vegetarian" name="vegetarian">
        <label for="vegetarian" class="form-check-label">Vegetarisch</label>
    </div>
    <div class="mb-3">
        <label for="food_intolerances" class="form-label">Essensunverträglichkeiten</label>
        <input class="form-control" id="food_intolerances" name="food_intolerances">
    </div>

    <h2>Gruppe</h2>
    <div class="mb-3">
        <div class="form-check">
            <input class="form-check-input" type="radio" name="in_jwbr" id="in_jwbr_yes" checked value="on">
            <label class="form-check-label" for="in_jwbr_yes">
                Ich bin in der Schar Jungwacht Blauring Herisau
            </label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="radio" name="in_jwbr" id="in_jwbr_no" value="off">
            <label class="form-check-label" for="in_jwbr_no">
                Ich bin <b>nicht</b> in der Schar Jungwacht Blauring Herisau
            </label>
        </div>
    </div>
    <div class="mb-3">
        <label for="group" class="form-label">Gruppe</label>
        <select class="form-select" id="group" name="group" required>
            <option value="Theseus">JW - Hermanos</option>
            <option value="Ivaros">JW - Ivaros</option>
            <option value="Chanticos">JW - Chanticos</option>
            <option value="Ueblos">JW - Ueblos</option>
            <option value="Cherokees">JW - Cherokees</option>
            <option value="Mukavajates">JW - Mukavajates</option>
            <option value="Lacasitas">BR - Philomenas</option>
            <option value="Mevas">BR - Akinas</option>
            <option value="Mevas">BR - Mevas</option>
            <option value="Picus">BR - Picus</option>
            <option value="Mahinas">BR - Mahinas</option>
            <option value="Giblias">BR - Giblias</option>
            <option value="Gorayadas">BR - Gorayadas</option>
        </select>
    </div>

    <h2>Eltern</h2>
    <div class="mb-3">
        <label for="parents_name" class="form-label">Name der Eltern</label>
        <input type="text" class="form-control" id="parents_name" name="parents_name" required>
    </div>
    <div class="mb-3">
        <label for="parents_address" class="form-label">Anschrift</label>
        <textarea id="parents_address" name="parents_address" class="form-control" rows="5" required></textarea>
    </div>
    <div class="mb-3 row">
        <div class="col-md-4 col-sm-12">
            <label for="tel_private" class="form-label">Tel. Privat</label>
            <input type="tel" class="form-control" id="tel_private" name="tel_private" required>
        </div>
        <div class="col-md-4 col-sm-12">
            <label for="tel_mobile" class="form-label">Tel. Mobil</label>
            <input type="tel" class="form-control" id="tel_mobile" name="tel_mobile">
        </div>
        <div class="col-md-4 col-sm-12">
            <label for="tel_work" class="form-label">Tel. Geschäft</label>
            <input type="tel" class="form-control" id="tel_work" name="tel_work">
        </div>
    </div>

    <h2>Medizinische Informationen</h2>
    <p>Die Versicherung ist Sache der Teilnehmer!!</p>
    <div class="mb-3 row">
        <div class="col">
            <label for="accident_insurance" class="form-label">Unfallversicherung</label>
            <input type="text" class="form-control" id="accident_insurance" name="accident_insurance" required>
        </div>
        <div class="col">
            <label for="sickness_insurance" class="form-label">Krankenkasse</label>
            <input type="text" class="form-control" id="sickness_insurance" name="sickness_insurance" required>
        </div>
    </div>
    <div class="mb-3">
        <label for="doctor_contact" class="form-label">Name, Anschrift und Telefon Hausarzt</label>
        <textarea id="doctor_contact" name="doctor_contact" class="form-control" rows="5" required></textarea>
    </div>
    <div class="mb-3">
        <label for="allergies" class="form-label">Allergien</label>
        <input type="text" id="allergies" name="allergies" class="form-control">
    </div>
    <div class="mb-3">
        <input type="checkbox" class="form-check-input" id="tick_vaccinated" name="tick_vaccinated">
        <label for="tick_vaccinated" class="form-check-label">Gegen Zecken geimpft</label>
    </div>
    <div class="mb-3">
        <input type="checkbox" class="form-check-input" id="tetanus_vaccinated" name="tetanus_vaccinated">
        <label for="tetanus_vaccinated" class="form-check-label">
            Gegen Starrkrampf geimpft (auch Tetanus genannt)
        </label>
    </div>
    <div class="mb-3">
        <label for="last_tetanus_date" class="form-label">Datum der letzten Starrkrampfimpfung</label>
        <input type="date" class="form-control" id="last_tetanus_date" name="last_tetanus_date">
    </div>
    <div class="mb-3">
        <label class="form-label" for="diseases">Vorliegende Erkrankungen</label>
        <input type="text" class="form-control" id="diseases" name="diseases"
               placeholder="Asthma, ADHS, Herzfehler, etc.">
    </div>
    <div class="mb-3">
        <label class="form-label" for="regularly_taken_medications">
            Medikamente, die regelmässig eingenommen werden müssen
        </label>
        <input type="text" class="form-control" id="regularly_taken_medications" name="regularly_taken_medications">
    </div>
    <div class="mb-3 row">
        <div class="col">
            <label for="vaccination_card" class="form-label">Impfausweis</label>
            <input class="form-control" type="file" id="vaccination_card" name="vaccination_card">
        </div>
        <div class="col">
            <label for="insurance_card" class="form-label">Krankenkassenkarte</label>
            <input class="form-control" type="file" id="insurance_card" name="insurance_card" required>
        </div>
    </div>

    <h2>Grösse T-Shirt</h2>
    <div class="mb-3">
        <label for="tshirtsize" class="form-label">Grösse T-Shirt</label>
        <select class="form-select" id="tshirtsize" name="tshirtsize" required>
            <option value="98/104">98/104</option>
            <option value="110/116">110/116</option>
            <option value="122/128">122/128</option>
            <option value="134/140">134/140</option>
            <option value="152">152</option>
            <option value="S">S</option>
            <option value="M">M</option>
            <option value="L">L</option>
            <option value="XL">XL</option>
            <option value="XXL">XXL</option>
            <option value="3XL">3XL</option>
            <option value="4XL">4XL</option>
            <option value="5XL">5XL</option>
        </select>
        <p>
            <a class="" data-bs-toggle="collapse" href="#tshirtSizesCollapse" role="button" aria-expanded="false"
               aria-controls="tshirtSizesCollapse">
                Grössentabelle
            </a>
        </p>
        <div class="collapse" id="tshirtSizesCollapse">
            <div class="card card-body">
                <div class="row">
                    <div class="col">
                        <img src="tshirt.webp" alt="T-Shirt" width="320">
                    </div>
                    <div class="col">
                        <table class="table table-sm">
                            <thead>
                            <tr>
                                <td></td>
                                <td>A (mm)</td>
                                <td>B (mm)</td>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>98/104 (3-4 Jahre)</td>
                                <td>430</td>
                                <td>340</td>
                            </tr>
                            <tr>
                                <td>110/116 (5-6 Jahre)</td>
                                <td>470</td>
                                <td>370</td>
                            </tr>
                            <tr>
                                <td>122/128 (7-8 Jahre)</td>
                                <td>510</td>
                                <td>400</td>
                            </tr>
                            <tr>
                                <td>134/140 (9-10 Jahre)</td>
                                <td>550</td>
                                <td>430</td>
                            </tr>
                            <tr>
                                <td>152 (11-12 Jahre)</td>
                                <td>630</td>
                                <td>460</td>
                            </tr>
                            <tr>
                                <td>S</td>
                                <td>665</td>
                                <td>460</td>
                            </tr>
                            <tr>
                                <td>M</td>
                                <td>690</td>
                                <td>510</td>
                            </tr>
                            <tr>
                                <td>L</td>
                                <td>715</td>
                                <td>560</td>
                            </tr>
                            <tr>
                                <td>XL</td>
                                <td>740</td>
                                <td>610</td>
                            </tr>
                            <tr>
                                <td>XXL</td>
                                <td>765</td>
                                <td>660</td>
                            </tr>
                            <tr>
                                <td>3XL</td>
                                <td>790</td>
                                <td>730</td>
                            </tr>
                            <tr>
                                <td>4XL</td>
                                <td>805</td>
                                <td>780</td>
                            </tr>
                            <tr>
                                <td>5XL</td>
                                <td>820</td>
                                <td>830</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h2>Anwesenheit</h2>
    <div class="">
        <input type="checkbox" class="form-check-input" id="present_week_1" name="present_week_1" checked>
        <label for="present_week_1" class="form-check-label">
            Anwesend in der ersten Woche (06.07.2024-13.07.2024)
        </label>
    </div>
    <div class="">
        <input type="checkbox" class="form-check-input" id="present_week_2" name="present_week_2" checked>
        <label for="present_week_2" class="form-check-label">
            Anwesend in der zweiten Woche (13.07.2024-20.07.2024)
        </label>
    </div>
    <div class="form-text mb-3">Aktiviere beide Kästchen, wenn du in beiden Wochen anwesend bist.</div>

    <h2>Allgemeines</h2>
    <div class="mb-3">
        <label for="remarks" class="form-label">Bemerkungen</label>
        <textarea id="remarks" name="remarks" class="form-control" rows="5"></textarea>
    </div>
    <div class="mb-3">
        <input type="checkbox" class="form-check-input" id="allow_photos" name="allow_photos" required>
        <label for="allow_photos" class="form-check-label">
            Ich bin damit einverstanden, dass im Lager gemachte Fotos
            von Jungwacht Blauring Herisau weiterverwendet werden dürfen, insbesondere für soziale
            Netzwerke, Zeitungen, Lagerblog und die Homepage.
        </label>
        <div class="invalid-feedback pt-3">Diese Checkbox muss aktiviert sein</div>
    </div>
    <div class="mb-3">
        <input type="checkbox" class="form-check-input" id="allow_privacy" name="allow_privacy" required>
        <label for="allow_privacy" class="form-check-label">
            Ich bin mit der <a href="https://jwbr.jimdo.com/app/download/12500444712/%C3%96ffentlicheDatenschutzerkl%C3%A4rung.pdf">Datenschutzerklärung</a> einverstanden.
        </label>
        <div class="invalid-feedback pt-3">Diese Checkbox muss aktiviert sein</div>
    </div>

    <h2>Unterschrift der Eltern</h2>
    <div class="mb-3">
        <div class="wrapper">
            <canvas id="signature-pad" width="400" height="200"></canvas>
        </div>
        <div class="clear-btn">
            <button id="signature-clear" class="btn btn-sm btn-secondary" type="button">Neu beginnen</button>
        </div>
    </div>
    <div class="invalid-feedback" id="form_not_complete_message">
        Das Formular ist noch nicht vollständig ausgefüllt. Bitte korrigiere die rot umrahmten Felder.
    </div>
    <button type="button" class="btn btn-primary" id="form_submit">Anmeldung abschicken</button>
</form>
<div id="success" style="display: none">
    <h2>Anmeldung abgeschickt</h2>
    <p>Vielen Dank für deine Anmeldung! Du wirst in Kürze eine Mail als Bestätigung erhalten.</p>
    <a href=".">Zurück zum Anmeldeformular</a>
</div>
<div id="form_send_error" style="display: none" class="alert alert-danger fade show">
    Leider konnte das Formular nicht verarbeitet werden. Bitte versuch es später noch einmal.
</div>

<script>
    async function readFileInputToFormObject(input_id) {
        const reader = new FileReader();
        const file = document.getElementById(input_id).files[0];
        if (file === undefined) {
            return "";
        }
        const result = await new Promise((resolve, reject) => {
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });

        return result.toString();
    }

    document.addEventListener("DOMContentLoaded", () => {
        let tetanus_vaccinated = document.getElementById("tetanus_vaccinated");
        let last_tetanus_date = document.getElementById("last_tetanus_date").parentElement;
        let update_tetanus_date = () => {
            last_tetanus_date.required = tetanus_vaccinated.checked;
            last_tetanus_date.style.display = tetanus_vaccinated.checked ? "initial" : "none";
        };
        tetanus_vaccinated.addEventListener("change", update_tetanus_date);
        update_tetanus_date();


        const canvas = document.getElementById("signature-pad");
        const signaturePad = new SignaturePad(canvas, {
            backgroundColor: 'rgb(250,250,250)'
        });

        /*function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear(); // otherwise isEmpty() might return incorrect value
        }

        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();
        */

        document.getElementById("signature-clear").addEventListener("click", () => signaturePad.clear());


        const form = document.getElementById("registration_form");
        let success_msg = document.getElementById("success");
        let error_msg = document.getElementById("form_send_error");
        let form_incomplete_msg = document.getElementById("form_not_complete_message");

        document.getElementById("form_submit").addEventListener("click", async event => {
            form.classList.add('was-validated');
            let formValid = form.checkValidity();
            form_incomplete_msg.style.display = formValid ? "none" : "block";
            if (!formValid) {
                console.log("form invalid");
                event.preventDefault();
                event.stopPropagation();
            } else {
                const xhr = new XMLHttpRequest();
                const formData = new FormData(form);
                let functionURL = window.location.hostname === "localhost"
                    ? 'http://localhost:7071/api/Anmeldung'
                    : "https://lageranmeldung.azurewebsites.net/api/Anmeldung?code=X1SFOMDAP9DSTGlr8YM2A1eWg_-_HZ1IVs5tAhdheb7MAzFuRC9u5Q==";
                xhr.open('POST', functionURL);
                xhr.setRequestHeader("Content-Type", "application/json");

                let dataObject = Object.fromEntries(formData);
                dataObject.vaccination_card = await readFileInputToFormObject("vaccination_card");
                dataObject.insurance_card = await readFileInputToFormObject("insurance_card");
                dataObject.signature = signaturePad.toDataURL("image/png");

                xhr.send(JSON.stringify(dataObject));
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (200 <= xhr.status && xhr.status < 300) {
                            form.reset();
                            form.style.display = "none";
                            error_msg.style.display = "none";
                            success_msg.style.display = "initial";
                        } else {
                            error_msg.style.display = "initial";
                        }
                        console.log(xhr.status, xhr.statusText);
                        console.log(xhr.response);
                    }
                }
            }

            return false;
        });

        ["input", "textarea", "select"].forEach(tag => document.querySelectorAll(`${tag}:required`).forEach(add_invalid_feedback_if_needed));
    });

    function add_invalid_feedback_if_needed(inp) {
        if (inp.parentNode.querySelector(".invalid-feedback") == null) {
            let div = document.createElement("div");
            div.classList.add("invalid-feedback");
            div.innerText = "Dieses Feld darf nicht leer sein.";
            inp.parentNode.insertBefore(div, inp.nextSibling);
        }
    }
</script>
</body>
</html>
